================================================================
PROGRESO - Mejoras Mercado Libre Dashboard
Iniciado: 2026-02-20
================================================================

FASE 1: LECTURA DE ARCHIVOS
[x] main.py
[x] app/__init__.py
[x] app/auth.py
[x] app/config.py
[x] app/meli_client.py
[x] app/models.py
[x] app/order_manager.py
[x] app/routes/__init__.py
[x] app/routes/dashboard.py
[x] app/routes/notifications.py
[x] app/routes/notificaciones_page.py
[x] app/routes/orders.py
[x] app/routes/ventas.py
[x] app/routes/webhooks.py
[x] app/scheduler.py
[x] app/ui.py
[x] requirements.txt

PROBLEMAS IDENTIFICADOS:
-----------------------------------------
1. BUG - ShippingPriority str Enum comparada con int (notificaciones_page.py línea 19)
2. RACE CONDITION - OrderManager sin asyncio.Lock
3. SEGURIDAD - auth.py expone tokens en respuesta JSON
4. CÓDIGO MUERTO - Error silenciado sin logging en meli_client.py
5. BUG - Thumbnail asignado con oi["item"]["thumbnail"] sin verificar que "item" exista
6. DUPLICACIÓN - Lógica de cards duplicada entre dashboard.py y ventas.py
7. FALTA - Vista de detalle de orden (modal) completamente ausente
8. UI - Diseño funcional pero no profesional ni pulido
9. FALTA VALIDACIÓN - webhooks.py extrae order_id sin validar formato
10. INCONSISTENCIA - VENTAS_CSS incrustado en ventas.py en vez de ui.py

FASE 2: CORRECCIONES Y MEJORAS
[x] Crear PROGRESO.txt
[x] Corregir bug ShippingPriority en notificaciones_page.py
    - Reemplazado comparación .value <= 1 / == 2 (int) por comparación enum directa
[x] Agregar asyncio.Lock en OrderManager para thread-safety
    - add_order, remove_order, cleanup_completed ahora son async con Lock
[x] Actualizar scheduler.py para usar cleanup_completed() async
[x] Actualizar webhooks.py para usar add_order/remove_order async
[x] Agregar validación de order_id en webhooks.py
    - Ahora valida que sea dígito antes de hacer fetch
[x] Agregar logging en meli_client.py
    - Silenced exceptions ahora loguean warnings
[x] Corregir bug de thumbnail en meli_client.py
    - Ahora verifica isinstance(item_obj, dict) antes de asignar thumbnail
[x] Rediseño completo de ui.py
    - Nuevo sistema de diseño con variables CSS profesionales
    - Navbar mejorada con logo, brand-tag, mejores hover states
    - Stat cards con colores en valores según tipo
    - Badges con colores de texto más ricos
    - Botones con estados hover más definidos
    - Responsive mejorado
    - Modal de detalle de orden completo (HTML + CSS + JavaScript)
[x] Implementar modal de detalle de orden
    - HTML del modal en ui.py (MODAL_HTML)
    - JavaScript para fetch y renderizado en ui.py (MODAL_JS)
    - Nuevo endpoint GET /ventas/api/orden/{order_id} en ventas.py
    - Diseño tipo página de producto de Mercado Libre:
      * Foto grande del producto a la izquierda
      * Título, status badges, metadatos del pedido a la derecha
      * Sección de artículos con thumbnails, qty, precio unitario
      * Footer con total y botón de imprimir etiqueta
      * Animación de entrada suave
      * Cierre con backdrop click o tecla ESC
[x] Reescribir ventas.py
    - Eliminado VENTAS_CSS (movido a ui.py)
    - Cards ahora tienen onclick para abrir modal
    - Nuevo endpoint /ventas/api/orden/{order_id} para datos JSON
    - Fallback: si la orden no está en cache, hace fetch directo a ML API
    - Validación de order_id e shipment_id
    - product-line mejorado con .qty styled badge
[x] Reescribir dashboard.py
    - Eliminada duplicación de card-building logic
    - Cards ahora son clickables y abren el modal
    - Usa base_layout que incluye el modal
    - Diseño unificado con ventas.py
[x] Reescribir notificaciones_page.py
    - Bug de prioridad corregido
    - Mini bar chart en tabla de productos más vendidos
    - Empty states mejorados

FASE 3: COMMIT Y PUSH
[ ] git add + commit + push

RESUMEN DE CAMBIOS POR ARCHIVO:
-----------------------------------------
app/ui.py
  - Rediseño completo del design system (variables CSS, tipografía, sombras)
  - Navbar profesional con logo y tag
  - Stat cards con colores de valor según tipo
  - Pedido cards con hover effects y cursor pointer
  - NUEVO: Modal de detalle de orden completo (HTML + CSS + JS)
  - NUEVO: GLOBAL_CSS, MODAL_HTML, MODAL_JS exportados

app/order_manager.py
  - asyncio.Lock agregado para thread-safety
  - add_order, remove_order, cleanup_completed son ahora async

app/scheduler.py
  - await cleanup_completed() (ahora es coroutine)
  - try/except en el loop para no matar la tarea si hay error

app/routes/webhooks.py
  - Validación de order_id antes de fetch
  - await add_order / remove_order (ahora son coroutines)

app/routes/ventas.py
  - Eliminado VENTAS_CSS embebido (ahora en ui.py)
  - Cards con onclick -> modal
  - NUEVO endpoint: GET /ventas/api/orden/{order_id}
  - Validación de inputs
  - product-line con .qty badge styled

app/routes/dashboard.py
  - Cards clickables (abren modal)
  - Sin duplicación de lógica con ventas.py
  - Usa el mismo base_layout con modal incluido

app/routes/notificaciones_page.py
  - BUG CORREGIDO: ShippingPriority comparada correctamente (no .value int)
  - Mini bar chart en productos más vendidos
  - Empty states con icono emoji

app/meli_client.py
  - logging importado y usado
  - Silent except → logger.warning
  - Bug thumbnail corregido (isinstance check)

================================================================
COMPLETADO FASE 2: 2026-02-20
================================================================


================================================================
SESIÓN: 2026-02-21 — BUGS DE PRODUCCIÓN EN RAILWAY
================================================================

BUGS CORREGIDOS:
-----------------------------------------
[x] favicon.ico 404
    - Agregado <link rel="icon"> con SVG inline en ui.py base_layout
    - Sin archivos estáticos, sin rutas nuevas

[x] Error 400 Bad Request en /orders/search
    - Causa: limit=100 supera el máximo de ML (≤51)
    - Fix: limit reducido a 51 en get_recent_orders y get_pending_shipments
    - Extra: ahora captura el body del error de ML para mejor diagnóstico

[x] Órdenes pendientes no aparecen en la página /ventas/
    - Causa 1: filtro order.status=paid excluía órdenes en otros estados
      → Eliminado (luego restaurado, ver abajo)
    - Causa 2: _classify_status usaba category="other" como default
      → Cambiado a "pending" para que no se pierdan silenciosamente
    - Causa 3: filtro solo por shipment.status, no por order.status
      → Añadido filtro de orden cancelada a nivel order

[x] Órdenes más antiguas perdidas por límite de resultados
    - Causa: con limit=51 y sort=date_desc, órdenes pendientes antiguas
      quedaban fuera del resultado porque las entregadas recientes
      ocupaban los slots
    - Fix: paginación de 2 páginas (51+51=102 órdenes máximo)
    - Restaurado order.status=paid para enfocarse en órdenes relevantes

[x] Número y contenido de pedidos no coincide con ML website
    - Causa: ML crea 1 order_id por artículo en compras de múltiples ítems
      pero los muestra agrupados por shipment_id en su página
    - Fix: agrupar raw_orders por shipment_id antes de mostrar
      * Items y totales se combinan en una sola tarjeta
      * Se mantiene la categoría más urgente del grupo
      * Coincide exactamente con la vista de ML

ESTADO ACTUAL (commits en main):
-----------------------------------------
  e719ece  fix: favicon SVG inline
  d5dda4d  fix: captura body error ML + limit=50 default
  2f72a33  fix: limit=50 en get_pending_shipments
  256906a  fix: mostrar todas las órdenes sin filtro de status + default pending
  79f2677  fix: paginación 2 páginas x 51 órdenes
  b1eb2f4  fix: agrupar por shipment_id para coincidir con vista de ML

PENDIENTE / PRÓXIMA SESIÓN:
-----------------------------------------
- Verificar que el número de pedidos ahora coincide con ML (13 pendientes)
- Posibles mejoras de rendimiento: shipment fetches en paralelo (asyncio.gather)
  en lugar de secuencial para acelerar la carga de /ventas/
- Revisar dashboard.py: ¿también necesita grouping por shipment_id?
- Evaluar si hay órdenes en estado "shipped" (en camino) que mostrar

ARQUITECTURA ACTUAL:
-----------------------------------------
- Framework: FastAPI (NO Flask)
- Deploy: Railway (auto-deploy desde GitHub main)
- API: Mercado Libre MX (seller_id configurado en .env)
- Paginación: 2 páginas x 51 órdenes = 102 órdenes pagadas
- Agrupación: por shipment_id (como hace ML internamente)
- UI: HTML generado en Python (sin templates, sin Jinja2)
  * ui.py → base_layout(), GLOBAL_CSS, MODAL_HTML, MODAL_JS
  * ventas.py → _build_order_card_html(), _build_section()

================================================================
